<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de Cotizaciones - Universal</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px
    }
    .container{
      max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;
      box-shadow:0 10px 40px rgba(0,0,0,.2);
      display:grid;grid-template-columns:1fr 1fr;gap:30px;padding:30px
    }
    .header{grid-column:1/-1;text-align:center;margin-bottom:20px;border-bottom:2px solid #667eea;padding-bottom:20px}
    .header h1{color:#333;font-size:28px;margin-bottom:5px}
    .header p{color:#666;font-size:14px}
    .section{padding:20px;background:#f8f9fa;border-radius:8px}
    .section h2{color:#333;margin-bottom:20px;font-size:20px;border-bottom:2px solid #667eea;padding-bottom:10px}
    label{display:block;color:#555;font-weight:600;margin-bottom:5px;font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .search-group{display:flex;gap:10px;margin-bottom:15px}
    .search-group input{flex:1}
    button{
      background:#667eea;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;
      font-weight:600;transition:all .2s ease
    }
    button:hover{background:#764ba2;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.3)}
    button:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
    .button-group{display:flex;gap:10px;margin-top:14px}
    .button-group button{flex:1}
    .secondary{background:#6c757d}
    .secondary:hover{background:#5a6268}
    .success{background:#28a745}
    .success:hover{background:#218838}
    .danger{background:#dc3545}
    .danger:hover{background:#c82333}
    .order-info{
      background:#fff;padding:15px;border-radius:6px;margin-bottom:12px;border-left:4px solid #667eea;
      cursor:pointer;transition:all .15s
    }
    .order-info:hover{box-shadow:0 3px 10px rgba(102,126,234,.2);transform:translateX(5px)}
    .order-info p{color:#666;margin:5px 0;font-size:13px}
    .items-container{
      background:#fff;border-radius:6px;padding:15px;max-height:320px;overflow-y:auto
    }
    .item-row{
      display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:10px;padding:12px;border-bottom:1px solid #eee;align-items:center
    }
    .item-row:last-child{border-bottom:none}
    .item-row input{padding:8px}
    .item-row button{padding:8px 12px;font-size:12px;background:#dc3545}
    .add-item-group{
      display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:10px;margin-top:15px
    }
    .add-item-group input,.add-item-group select{padding:8px}
    .add-item-group button{padding:8px 12px;background:#28a745}
    .summary{background:#fff;padding:15px;border-radius:6px;margin-top:15px}
    .summary-row{display:flex;justify-content:space-between;margin:8px 0;font-size:14px;color:#666}
    .summary-row strong{color:#333}
    .summary-row.total{font-size:18px;font-weight:700;color:#667eea;border-top:2px solid #eee;padding-top:10px;margin-top:10px}
    .preview{
      background:#fff;padding:20px;border-radius:6px;margin-top:15px;border:2px solid #667eea;min-height:240px
    }
    .preview h3{color:#667eea;margin-bottom:12px;font-size:16px}
    .preview-content{
      color:#333;line-height:1.6;font-size:14px;white-space:pre-wrap;word-wrap:break-word;background:#f8f9fa;
      padding:15px;border-radius:6px;font-family:'Courier New',monospace
    }
    .alert{padding:12px 15px;border-radius:6px;margin-bottom:15px;font-size:13px}
    .alert.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    .alert.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .alert.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .muted{color:#888;font-size:11px;margin-top:6px}
    @media(max-width:768px){
      .container{grid-template-columns:1fr;gap:20px}
      .add-item-group,.item-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß Generador de Cotizaciones</h1>
      <p>Universal - Cotiza por m√°quina, guarda en BD y env√≠a un SOLO WhatsApp final</p>
      <div style="margin-top:10px;font-size:13px;color:#666;">
        Bienvenido, <strong id="headerUserName"></strong>
        <button onclick="doLogout()" style="margin-left:12px;padding:4px 12px;font-size:12px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;">Cerrar sesi√≥n</button>
      </div>
    </div>

    <!-- IZQUIERDA -->
    <div class="section">
      <h2>üìã Seleccionar Orden</h2>

      <div class="form-group">
        <label>Buscar por N√∫mero de Orden, C√©dula, Nombre o Tel√©fono</label>
        <div class="search-group">
          <input id="searchInput" placeholder="Ej: 441 | 1030... | HERNANDO | 301..." />
          <button onclick="searchOrders()">Buscar</button>
        </div>
      </div>

      <div id="searchResults"></div>

      <div id="orderInfo" style="display:none;margin-top:20px;">
        <div class="alert info"><strong>‚úÖ Orden Cargada</strong></div>

        <div class="order-info" style="margin:0;cursor:default;">
          <p><strong>N√∫mero:</strong> <span id="orderNumber">-</span></p>
          <p><strong>Cliente:</strong> <span id="clientName">-</span></p>
          <p><strong>Contacto:</strong> <span id="clientContact">-</span></p>
          <p><strong>Tel√©fono:</strong> <span id="clientPhone">-</span></p>
          <p><strong>Fecha de ingreso:</strong> <span id="orderDate">-</span></p>

          <p><strong>M√°quinas en la orden:</strong> <span id="equipmentCount">0</span></p>
          <p><strong>Cotizaciones guardadas:</strong> <span id="savedCount">0</span></p>

          <p><strong>M√°quina seleccionada:</strong> <span id="equipmentName">-</span></p>
          <p><strong>Marca/Serial:</strong> <span id="equipmentBrand">-</span></p>

          <div style="margin-top:12px;">
            <label style="font-size:12px;"><strong>Seleccionar m√°quina para cotizar</strong></label>
            <select id="equipmentSelect" onchange="onEquipmentChange()">
              <option value="">-- Selecciona una m√°quina --</option>
            </select>
            <div id="equipmentList" style="margin-top:10px;font-size:12px;color:#666;"></div>
          </div>

          <div id="statusActions" style="display:none;margin-top:12px;display:flex;flex-direction:column;gap:6px;">
            <button type="button" onclick="notifyParts()" style="background:#FF9800;color:#fff;border:none;border-radius:5px;padding:7px 10px;font-size:12px;cursor:pointer;text-align:left;">
              üì¶ Enviar lista de repuestos al encargado <span style="opacity:.7;font-size:11px;">(autorizadas)</span>
            </button>
            <button type="button" onclick="notifyReady()" style="background:#9C27B0;color:#fff;border:none;border-radius:5px;padding:7px 10px;font-size:12px;cursor:pointer;text-align:left;">
              üîß Notificar al cliente ‚Äî m√°quinas listas <span style="opacity:.7;font-size:11px;">(reparadas)</span>
            </button>
            <button type="button" onclick="notifyDelivered()" style="background:#009688;color:#fff;border:none;border-radius:5px;padding:7px 10px;font-size:12px;cursor:pointer;text-align:left;">
              ‚úÖ Confirmar entrega al cliente <span style="opacity:.7;font-size:11px;">(entregadas)</span>
            </button>
          </div>

          <div style="margin-top:12px;">
            <label style="font-size:12px;"><strong>T√©cnico asignado</strong></label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="technicianSelect" onchange="onTechnicianChange()" style="flex:1;">
                <option value="">(Sin asignar)</option>
              </select>
              <button type="button" onclick="assignTechnicianToAll()" class="secondary">A todas</button>
            </div>
            <div id="techWarning" class="muted"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:30px;">
        <h3 style="color:#555;margin-bottom:15px;font-size:15px;">üìö √ìrdenes Recientes</h3>
        <div id="recentOrders"></div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="section">
      <h2>üí∞ Cotizar M√°quina Seleccionada</h2>

      <div class="form-group">
        <label>Mano de Obra (valor en $)</label>
        <input type="number" id="laborCost" placeholder="Ej: 50000" min="0" onchange="updateSummary()" />
      </div>

      <div class="form-group">
        <label>Descripci√≥n del trabajo</label>
        <textarea id="workDescription" rows="3" placeholder="Describe el trabajo..."></textarea>
      </div>

      <h3 style="color:#555;margin-top:20px;margin-bottom:10px;font-size:15px;">‚öôÔ∏è Repuestos (de esta m√°quina)</h3>

      <div class="items-container" id="itemsContainer">
        <p style="color:#999;text-align:center;padding:20px;">(Sin repuestos a√∫n)</p>
      </div>

      <div class="add-item-group">
        <select id="partSelect">
          <option value="">-- Cat√°logo de Repuestos --</option>
        </select>
        <input type="number" id="partQuantity" value="1" min="1" placeholder="Cantidad" />
        <input type="text" id="customPartName" placeholder="O escribir repuesto" />
        <button onclick="addItem()">+ Agregar</button>
      </div>

      <div class="summary">
        <div class="summary-row"><span>Subtotal m√°quina:</span> <strong id="subtotalDisplay">$0</strong></div>
        <div class="summary-row"><span>IVA:</span> <strong id="taxDisplay">$0</strong></div>
        <div class="summary-row total"><span>TOTAL m√°quina:</span> <strong id="totalDisplay">$0</strong></div>
        <div class="muted">* IVA: No aplica</div>
      </div>

      <div class="button-group">
        <button class="secondary" onclick="saveMachineQuote()" id="saveBtn">üíæ Guardar m√°quina</button>
        <button onclick="generateFinalMessage()" id="genFinalBtn">ü§ñ Mensaje final</button>
        <button class="success" onclick="sendFinalWhatsApp()" id="sendFinalBtn" disabled>üì± Enviar final</button>
        <button class="danger" onclick="resetMachineForm()">üîÑ Limpiar</button>
      </div>

      <p class="muted" style="margin-top:14px;">üìã Cotizaci√≥n PDF (toda la orden):</p>
      <div class="button-group" style="margin-top:4px;">
        <button class="secondary" onclick="downloadQuotePDF()">üìÑ Descargar PDF</button>
        <button class="secondary" onclick="sendQuotePDF()" id="sendQuotePDFBtn">üì§ Enviar por WhatsApp</button>
      </div>

      <p class="muted" style="margin-top:10px;">üîß Informe de mantenimiento (m√°quina seleccionada):</p>
      <div class="button-group" style="margin-top:4px;">
        <button class="secondary" onclick="downloadMaintenancePDF()">üìÑ Descargar Informe</button>
        <button class="secondary" onclick="sendMaintenancePDF()" id="sendMaintPDFBtn">üì§ Enviar Informe WA</button>
      </div>

      <div class="preview">
        <h3>üëÄ Vista previa WhatsApp (cotizaci√≥n completa)</h3>
        <div class="preview-content" id="messagePreview">Aqu√≠ aparecer√° el mensaje FINAL (todas las m√°quinas)...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';

    // Verificar sesi√≥n al cargar
    (async function checkSession() {
      const res = await fetch('/me').then(r => r.json()).catch(() => ({}));
      if (!res.authenticated) { window.location.href = '/login'; return; }
      document.getElementById('headerUserName').textContent = res.user.nombre;
    })();

    async function doLogout() {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    const ESTADOS = [
      { value: 'pendiente_revision', label: 'Pendiente de revisi√≥n', color: '#888' },
      { value: 'revisada',           label: 'Revisada',              color: '#2196F3' },
      { value: 'cotizada',           label: 'Cotizada',              color: '#FF9800' },
      { value: 'autorizada',         label: 'Autorizada',            color: '#4CAF50' },
      { value: 'no_autorizada',      label: 'No autorizada',         color: '#F44336' },
      { value: 'reparada',           label: 'Reparada',              color: '#9C27B0' },
      { value: 'entregada',          label: 'Entregada',             color: '#009688' },
    ];

    function showToast(msg, duration = 3000) {
      let t = document.getElementById('_toast');
      if (!t) {
        t = document.createElement('div');
        t.id = '_toast';
        t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:10px 20px;border-radius:6px;font-size:13px;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = '1';
      clearTimeout(t._timer);
      t._timer = setTimeout(() => { t.style.opacity = '0'; }, duration);
    }

    let currentOrderId = null;
    let currentOrderData = null;

    let equipmentData = [];
    let techniciansData = [];
    let selectedEquipment = null;

    let currentQuoteItems = [];
    let finalMessage = '';

    // ===== Search =====
    async function searchOrders(){
      const q = document.getElementById('searchInput').value.trim();
      if(!q) return alert('Escribe algo para buscar');

      try{
        const r = await fetch(`${API_BASE}/orders/search?q=${encodeURIComponent(q)}`);
        if(!r.ok) throw new Error('Error en b√∫squeda');
        const orders = await r.json();

        const box = document.getElementById('searchResults');
        box.innerHTML = '';

        if(!orders.length){
          box.innerHTML = '<div class="alert info">‚ùå No se encontraron √≥rdenes</div>';
          return;
        }

        orders.forEach(o=>{
          const div = document.createElement('div');
          div.className='order-info';
          div.innerHTML = `
            <p><strong>Orden #${o.ord_consecutivo}</strong></p>
            <p>${o.cli_razon_social}</p>
            <p style="color:#999;font-size:12px;">üìû ${o.cli_telefono||'-'}</p>
            <p style="color:#666;font-size:12px;">üß∞ M√°quinas: ${o.maquinas ?? '-'}</p>
            ${o.maquinas_resumen ? `<p style="color:#999;font-size:11px;margin-top:4px;">${o.maquinas_resumen}</p>` : ''}
          `;
          div.onclick = ()=> loadOrder(o);
          box.appendChild(div);
        });
      }catch(e){
        console.error(e);
        document.getElementById('searchResults').innerHTML = '<div class="alert error">‚ö†Ô∏è Error al buscar</div>';
      }
    }

    // ===== Load order detail =====
    async function loadOrder(order){
      try{
        const resp = await fetch(`${API_BASE}/orders/${encodeURIComponent(order.uid_orden)}`);
        if(!resp.ok) throw new Error('No se pudo cargar el detalle de la orden');
        const data = await resp.json();

        currentOrderId = data.order.uid_orden;
        currentOrderData = data.order;

        equipmentData = Array.isArray(data.equipment) ? data.equipment : [];
        techniciansData = Array.isArray(data.technicians) ? data.technicians : [];

        document.getElementById('orderNumber').textContent = data.order.ord_consecutivo;
        document.getElementById('clientName').textContent = data.order.cli_razon_social;
        document.getElementById('clientContact').textContent = data.order.cli_contacto || '-';
        document.getElementById('clientPhone').textContent = data.order.cli_telefono || '-';
        document.getElementById('orderDate').textContent = (function(raw) {
          if (!raw) return '-';
          const s = String(raw);
          // Formato YYYYMMDD
          const m8 = s.match(/^(\d{4})(\d{2})(\d{2})$/);
          if (m8) return `${m8[3]}/${m8[2]}/${m8[1]}`;
          // Formato YYYY-MM-DD o YYYY-MM-DDTHH:mm:ss
          const miso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (miso) return `${miso[3]}/${miso[2]}/${miso[1]}`;
          return '-';
        })(data.order.ord_fecha);

        document.getElementById('equipmentCount').textContent = String(data.equipmentCount ?? equipmentData.length);
        document.getElementById('savedCount').textContent = String(data.quotesSaved ?? 0);

        // warning t√©cnicos
        const tw = document.getElementById('techWarning');
        tw.textContent = data.techniciansWarning ? `‚ö†Ô∏è ${data.techniciansWarning}` : '';

        document.getElementById('orderInfo').style.display = 'block';
        document.getElementById('statusActions').style.display = 'flex';

        renderTechnicians(techniciansData);
        renderEquipment(equipmentData);

        // seleccionar primera
        if(equipmentData.length){
          selectedEquipment = equipmentData[0];
          document.getElementById('equipmentSelect').value = String(selectedEquipment.uid_herramienta_orden);
          paintSelectedEquipment(selectedEquipment);
          syncTechnicianSelect(selectedEquipment);
          await loadSavedQuoteForSelectedMachine();
        }else{
          selectedEquipment = null;
          paintSelectedEquipment(null);
          syncTechnicianSelect(null);
          resetMachineForm();
        }

        // cat√°logo
        loadPartsSelect();

        // limpiar resultados
        document.getElementById('searchResults').innerHTML='';
        document.getElementById('searchInput').value='';

        // refrescar contador guardadas
        await refreshSavedCount();

        // limpiar preview final
        finalMessage = '';
        document.getElementById('messagePreview').textContent = 'Aqu√≠ aparecer√° el mensaje FINAL (todas las m√°quinas)...';
        document.getElementById('sendFinalBtn').disabled = true;
      }catch(e){
        console.error(e);
        alert(`‚ö†Ô∏è ${e.message}`);
      }
    }

    function renderEquipment(list){
      const sel = document.getElementById('equipmentSelect');
      const box = document.getElementById('equipmentList');

      sel.innerHTML = '<option value="">-- Selecciona una m√°quina --</option>';
      box.innerHTML = '';

      if(!list.length){
        box.innerHTML = 'No hay m√°quinas asociadas a esta orden.';
        return;
      }

      list.forEach((eq, idx)=>{
        const tech = eq.tecnico_nombre ? ` ‚Äî Tec: ${eq.tecnico_nombre}` : '';
        const label = `${idx+1}. ${eq.her_nombre||'-'} ${eq.her_marca||''}${eq.her_serial ? ' / '+eq.her_serial : ''}${tech}`;
        const opt = document.createElement('option');
        opt.value = String(eq.uid_herramienta_orden);
        opt.textContent = label.trim();
        sel.appendChild(opt);
      });

      box.innerHTML = '';
      list.forEach((eq, idx) => {
        const tech = eq.tecnico_nombre ? ` | Tec: ${eq.tecnico_nombre}` : '';
        const estadoActual = eq.her_estado || 'pendiente_revision';
        const estadoInfo = ESTADOS.find(e => e.value === estadoActual) || ESTADOS[0];

        const opciones = ESTADOS.map(e =>
          `<option value="${e.value}"${e.value === estadoActual ? ' selected' : ''}>${e.label}</option>`
        ).join('');

        const uid = eq.uid_herramienta_orden;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;';
        row.innerHTML = `
          <span style="font-size:12px;color:#444;">‚Ä¢ ${idx+1}. ${eq.her_nombre||'-'} (${eq.her_marca||'-'})${eq.her_serial ? ' / '+eq.her_serial : ''}${tech}</span>
          <select id="status_${uid}" onchange="updateEquipmentStatus('${uid}', this)"
            style="font-size:11px;border-radius:4px;border:1px solid #ddd;padding:2px 6px;color:${estadoInfo.color};font-weight:600;cursor:pointer;">
            ${opciones}
          </select>`;
        box.appendChild(row);
      });
    }

    async function updateEquipmentStatus(uid, selectEl) {
      const status = selectEl.value;
      const prev = selectEl.dataset.prev || selectEl.value;
      selectEl.dataset.prev = status;
      try {
        const res = await fetch(`${API_BASE}/equipment-order/${encodeURIComponent(uid)}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        const data = await res.json();
        if (!data.success) {
          alert('Error al actualizar estado: ' + (data.error || 'Error desconocido'));
          selectEl.value = prev;
          return;
        }
        const estadoInfo = ESTADOS.find(e => e.value === status) || ESTADOS[0];
        selectEl.style.color = estadoInfo.color;
        selectEl.dataset.prev = status;
        // Actualizar dato en memoria
        const eq = equipmentData.find(e => String(e.uid_herramienta_orden) === String(uid));
        if (eq) eq.her_estado = status;
      } catch(e) {
        console.error(e);
        alert('Error de red al actualizar estado');
        selectEl.value = prev;
      }
    }

    async function notifyParts() {
      if (!currentOrderId) return;
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/notify-parts`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (!data.success) { alert('Error: ' + (data.error || 'Error desconocido')); return; }
        showToast(`üì¶ Lista enviada al encargado (${data.maquinas} m√°quina${data.maquinas !== 1 ? 's' : ''})`);
      } catch(e) { alert('Error de red: ' + e.message); }
    }

    async function notifyReady() {
      if (!currentOrderId) return;
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/notify-ready`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (!data.success) { alert('Error: ' + (data.error || 'Error desconocido')); return; }
        showToast(`üîß Cliente notificado (${data.maquinas} m√°quina${data.maquinas !== 1 ? 's' : ''} reparada${data.maquinas !== 1 ? 's' : ''})`);
      } catch(e) { alert('Error de red: ' + e.message); }
    }

    async function notifyDelivered() {
      if (!currentOrderId) return;
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/notify-delivered`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (!data.success) { alert('Error: ' + (data.error || 'Error desconocido')); return; }
        showToast(`‚úÖ Entrega confirmada al cliente (${data.maquinas} m√°quina${data.maquinas !== 1 ? 's' : ''})`);
      } catch(e) { alert('Error de red: ' + e.message); }
    }

    async function onEquipmentChange(){
      const id = document.getElementById('equipmentSelect').value;
      selectedEquipment = equipmentData.find(e => String(e.uid_herramienta_orden) === String(id)) || null;
      paintSelectedEquipment(selectedEquipment);
      syncTechnicianSelect(selectedEquipment);

      await loadSavedQuoteForSelectedMachine();
      loadPartsSelect();
    }

    function paintSelectedEquipment(eq){
      if(!eq){
        document.getElementById('equipmentName').textContent='-';
        document.getElementById('equipmentBrand').textContent='-';
        return;
      }
      document.getElementById('equipmentName').textContent = eq.her_nombre || '-';
      document.getElementById('equipmentBrand').textContent = (eq.her_marca||'-') + (eq.her_serial ? ` / ${eq.her_serial}` : '');
    }

    // ===== Technicians =====
    function renderTechnicians(list){
      const sel = document.getElementById('technicianSelect');
      sel.innerHTML = '<option value="">(Sin asignar)</option>';

      if(!Array.isArray(list) || !list.length) return;

      list.forEach(t=>{
        const opt = document.createElement('option');
        opt.value = String(t.uid_usuario);
        opt.textContent = t.usr_nombre || `T√©cnico ${t.uid_usuario}`;
        sel.appendChild(opt);
      });
    }

    function syncTechnicianSelect(eq){
      const sel = document.getElementById('technicianSelect');
      if(!sel) return;

      const techId = eq && (eq.tecnico_id ?? eq.uid_usuario_asignado);
      sel.value = techId ? String(techId) : '';
    }

    async function onTechnicianChange(){
      if(!currentOrderId || !selectedEquipment) return;

      const sel = document.getElementById('technicianSelect');
      const technicianId = sel.value ? sel.value : null;

      try{
        const resp = await fetch(`${API_BASE}/equipment-order/${encodeURIComponent(selectedEquipment.uid_herramienta_orden)}/assign-technician`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ technicianId })
        });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || data.details || 'No se pudo asignar');

        // actualizar memoria
        const map = new Map(techniciansData.map(t=>[String(t.uid_usuario), t.usr_nombre]));
        selectedEquipment.tecnico_id = technicianId;
        selectedEquipment.tecnico_nombre = technicianId ? (map.get(String(technicianId)) || '') : '';

        equipmentData = equipmentData.map(eq=>{
          if(String(eq.uid_herramienta_orden) === String(selectedEquipment.uid_herramienta_orden)){
            return { ...eq, tecnico_id: technicianId, tecnico_nombre: selectedEquipment.tecnico_nombre };
          }
          return eq;
        });

        renderEquipment(equipmentData);

        // si ya existe cotizaci√≥n guardada, actualiza t√©cnico al guardar
      }catch(e){
        console.error(e);
        alert(`‚ö†Ô∏è ${e.message}`);
      }
    }

    async function assignTechnicianToAll(){
      if(!currentOrderId) return;

      const sel = document.getElementById('technicianSelect');
      const technicianId = sel.value ? sel.value : null;

      if(!technicianId){
        const ok = confirm('¬øQuieres quitar el t√©cnico de TODAS las m√°quinas?');
        if(!ok) return;
      }

      try{
        const resp = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/assign-technician`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ technicianId })
        });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || data.details || 'No se pudo asignar');

        const map = new Map(techniciansData.map(t=>[String(t.uid_usuario), t.usr_nombre]));
        const techName = technicianId ? (map.get(String(technicianId)) || '') : '';

        equipmentData = equipmentData.map(eq=>({ ...eq, tecnico_id: technicianId, tecnico_nombre: techName }));
        if(selectedEquipment){
          selectedEquipment.tecnico_id = technicianId;
          selectedEquipment.tecnico_nombre = techName;
        }
        renderEquipment(equipmentData);
      }catch(e){
        console.error(e);
        alert(`‚ö†Ô∏è ${e.message}`);
      }
    }

    // ===== Parts catalog =====
    async function loadPartsSelect(){
      try{
        const r = await fetch(`${API_BASE}/quote/catalog?type=R`);
        if(!r.ok) throw new Error('Error cat√°logo');
        const parts = await r.json();
        const sel = document.getElementById('partSelect');
        sel.innerHTML = '<option value="">-- Cat√°logo de Repuestos --</option>';
        parts.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.uid_concepto_costo;
          opt.textContent = `${p.cco_descripcion} ($${Number(p.cco_valor||0).toLocaleString('es-CO')})`;
          opt.dataset.price = p.cco_valor;
          sel.appendChild(opt);
        });
      }catch(e){
        console.warn(e);
      }
    }

    // ===== Items machine =====
    function addItem(){
      const partSelect = document.getElementById('partSelect');
      const qty = parseInt(document.getElementById('partQuantity').value || '1', 10) || 1;
      const custom = document.getElementById('customPartName').value.trim();

      let name, price;

      if(partSelect.value){
        const opt = partSelect.options[partSelect.selectedIndex];
        name = opt.textContent.split(' ($')[0];
        price = Number(opt.dataset.price || 0);
      }else if(custom){
        name = custom;
        price = 0;
      }else{
        alert('Selecciona o escribe un repuesto');
        return;
      }

      currentQuoteItems.push({ id: Date.now(), name, quantity: qty, price });
      renderItems();
      updateSummary();

      partSelect.value='';
      document.getElementById('partQuantity').value='1';
      document.getElementById('customPartName').value='';
    }

    function renderItems(){
      const c = document.getElementById('itemsContainer');
      if(!currentQuoteItems.length){
        c.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">(Sin repuestos a√∫n)</p>';
        return;
      }
      c.innerHTML='';
      currentQuoteItems.forEach(it=>{
        const div = document.createElement('div');
        div.className='item-row';
        div.innerHTML = `
          <div><input type="text" value="${escapeHtml(it.name)}" readonly style="background:#fff;border:none;font-weight:500;cursor:text;"></div>
          <div><input type="number" value="${it.quantity}" min="1" onchange="updateItemQty(${it.id}, this.value)"></div>
          <div><input type="number" value="${it.price}" min="0" onchange="updateItemPrice(${it.id}, this.value)"></div>
          <button onclick="removeItem(${it.id})">‚ùå</button>
        `;
        c.appendChild(div);
      });
    }

    function updateItemQty(id, v){
      const it = currentQuoteItems.find(x=>x.id===id);
      if(it){ it.quantity = parseInt(v||'1',10)||1; updateSummary(); }
    }
    function updateItemPrice(id, v){
      const it = currentQuoteItems.find(x=>x.id===id);
      if(it){ it.price = Number(v)||0; updateSummary(); }
    }
    function removeItem(id){
      currentQuoteItems = currentQuoteItems.filter(x=>x.id!==id);
      renderItems();
      updateSummary();
    }

    function updateSummary(){
      const labor = Number(document.getElementById('laborCost').value) || 0;
      const itemsSubtotal = currentQuoteItems.reduce((s,it)=> s + (Number(it.quantity)||0)*(Number(it.price)||0), 0);
      const subtotal = labor + itemsSubtotal;
      const tax = 0;
      const total = subtotal;

      document.getElementById('subtotalDisplay').textContent = `$${subtotal.toLocaleString('es-CO',{maximumFractionDigits:0})}`;
      document.getElementById('taxDisplay').textContent = `$${tax.toLocaleString('es-CO',{maximumFractionDigits:0})}`;
      document.getElementById('totalDisplay').textContent = `$${total.toLocaleString('es-CO',{maximumFractionDigits:0})}`;
    }

    function resetMachineForm(){
      currentQuoteItems = [];
      document.getElementById('laborCost').value='';
      document.getElementById('workDescription').value='';
      document.getElementById('partSelect').value='';
      document.getElementById('partQuantity').value='1';
      document.getElementById('customPartName').value='';
      renderItems();
      updateSummary();
    }

    // ===== Guardar / cargar cotizaci√≥n por m√°quina =====
    async function loadSavedQuoteForSelectedMachine(){
      resetMachineForm();
      if(!currentOrderId || !selectedEquipment) return;

      try{
        const resp = await fetch(`${API_BASE}/quotes/machine?orderId=${encodeURIComponent(currentOrderId)}&equipmentOrderId=${encodeURIComponent(selectedEquipment.uid_herramienta_orden)}`);
        if(!resp.ok) return;

        const data = await resp.json();
        if(!data.exists) return;

        const mq = data.machineQuote;
        document.getElementById('laborCost').value = mq?.mano_obra ?? '';
        document.getElementById('workDescription').value = mq?.descripcion_trabajo ?? '';

        // items
        currentQuoteItems = (data.items || []).map(it=>({
          id: it.id || Date.now()+Math.random(),
          name: it.nombre,
          quantity: Number(it.cantidad||1),
          price: Number(it.precio||0)
        }));

        renderItems();
        updateSummary();
      }catch(e){
        console.warn(e);
      }
    }

    async function saveMachineQuote(){
      if(!currentOrderId) return alert('Selecciona una orden');
      if(!selectedEquipment) return alert('Selecciona una m√°quina');

      const laborCost = Number(document.getElementById('laborCost').value) || 0;
      const workDescription = document.getElementById('workDescription').value || '';
      const technicianId = document.getElementById('technicianSelect').value || null;

      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.textContent = 'üíæ Guardando...';

      try{
        const resp = await fetch(`${API_BASE}/quotes/machine`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            orderId: currentOrderId,
            equipmentOrderId: String(selectedEquipment.uid_herramienta_orden),
            technicianId,
            laborCost,
            workDescription,
            items: currentQuoteItems
          })
        });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || 'No se pudo guardar');

        alert('‚úÖ Cotizaci√≥n guardada para esta m√°quina');
        await refreshSavedCount();
      }catch(e){
        console.error(e);
        alert(`‚ö†Ô∏è ${e.message}`);
      }finally{
        btn.disabled = false;
        btn.textContent = 'üíæ Guardar m√°quina';
      }
    }

    async function refreshSavedCount(){
      if(!currentOrderId) return;
      try{
        const r = await fetch(`${API_BASE}/quotes/order/${encodeURIComponent(currentOrderId)}`);
        if(!r.ok) return;
        const data = await r.json();
        if(!data.success) return;
        document.getElementById('savedCount').textContent = String(data.savedCount ?? 0);
      }catch(e){}
    }

    // ===== Mensaje final =====
    async function generateFinalMessage(){
      if(!currentOrderId) return alert('Selecciona una orden');
      const btn = document.getElementById('genFinalBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Generando...';
      document.getElementById('messagePreview').textContent = 'Generando mensaje final...';

      try{
        const resp = await fetch(`${API_BASE}/quotes/order/${encodeURIComponent(currentOrderId)}/generate-message`,{ method:'POST' });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || 'No se pudo generar');

        finalMessage = data.message;
        document.getElementById('messagePreview').textContent = finalMessage;
        document.getElementById('sendFinalBtn').disabled = false;
      }catch(e){
        console.error(e);
        document.getElementById('messagePreview').textContent = `‚ö†Ô∏è ${e.message}`;
        document.getElementById('sendFinalBtn').disabled = true;
      }finally{
        btn.disabled = false;
        btn.textContent = 'ü§ñ Mensaje final';
      }
    }

    async function sendFinalWhatsApp(){
      if(!currentOrderId) return;
      const btn = document.getElementById('sendFinalBtn');
      btn.disabled = true;
      btn.textContent = 'üì§ Enviando...';

      try{
        const resp = await fetch(`${API_BASE}/quotes/order/${encodeURIComponent(currentOrderId)}/send-whatsapp`,{ method:'POST' });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || 'No se pudo enviar');

        alert(`‚úÖ Mensaje final enviado a ${data.phone}`);
        btn.textContent = 'üì± Enviar final';
      }catch(e){
        console.error(e);
        alert(`‚ö†Ô∏è ${e.message}`);
        btn.disabled = false;
        btn.textContent = 'üì± Enviar final';
      }
    }

    // ===== Recent orders =====
    async function loadRecentOrders(){
      try{
        const r = await fetch(`${API_BASE}/orders?limit=8`);
        if(!r.ok) throw new Error('Error');
        const orders = await r.json();
        const c = document.getElementById('recentOrders');
        c.innerHTML = '';

        if(!orders.length){
          c.innerHTML = '<p style="color:#999;font-size:13px;">No hay √≥rdenes recientes</p>';
          return;
        }

        orders.forEach(o=>{
          const div = document.createElement('div');
          div.className='order-info';
          div.style.marginBottom='10px';
          div.innerHTML = `
            <p><strong>#${o.ord_consecutivo}</strong> - ${o.cli_razon_social}</p>
            <p style="color:#999;font-size:12px;">üìÖ ${o.ord_fecha}</p>
          `;
          div.onclick = ()=> loadOrder(o);
          c.appendChild(div);
        });
      }catch(e){
        console.error(e);
        document.getElementById('recentOrders').innerHTML = '<p style="color:#c82333;font-size:12px;">‚ö†Ô∏è Error cargando √≥rdenes</p>';
      }
    }

    // ===== PDFs =====
    function downloadQuotePDF(){
      if(!currentOrderId) return alert('Selecciona una orden');
      window.open(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/pdf/quote`, '_blank');
    }

    async function sendQuotePDF(){
      if(!currentOrderId) return alert('Selecciona una orden');
      const btn = document.getElementById('sendQuotePDFBtn');
      btn.disabled = true; btn.textContent = '‚è≥ Enviando...';
      try{
        const resp = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/send-pdf/quote`, { method:'POST' });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || 'No se pudo enviar');
        alert('‚úÖ Cotizaci√≥n PDF enviada por WhatsApp');
      }catch(e){ alert(`‚ö†Ô∏è ${e.message}`); }
      finally{ btn.disabled = false; btn.textContent = 'üì§ Enviar por WhatsApp'; }
    }

    function downloadMaintenancePDF(){
      if(!currentOrderId) return alert('Selecciona una orden');
      if(!selectedEquipment) return alert('Selecciona una m√°quina');
      window.open(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/pdf/maintenance/${encodeURIComponent(selectedEquipment.uid_herramienta_orden)}`, '_blank');
    }

    async function sendMaintenancePDF(){
      if(!currentOrderId) return alert('Selecciona una orden');
      if(!selectedEquipment) return alert('Selecciona una m√°quina');
      const btn = document.getElementById('sendMaintPDFBtn');
      btn.disabled = true; btn.textContent = '‚è≥ Generando y enviando...';
      try{
        const resp = await fetch(`${API_BASE}/orders/${encodeURIComponent(currentOrderId)}/send-pdf/maintenance/${encodeURIComponent(selectedEquipment.uid_herramienta_orden)}`, { method:'POST' });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.success === false) throw new Error(data.error || 'No se pudo enviar');
        alert('‚úÖ Informe de mantenimiento enviado por WhatsApp');
      }catch(e){ alert(`‚ö†Ô∏è ${e.message}`); }
      finally{ btn.disabled = false; btn.textContent = 'üì§ Enviar Informe WA'; }
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadRecentOrders();
      loadPartsSelect();
      fetch('http://localhost:3001/health').catch(()=>{});
    });

    document.getElementById('searchInput').addEventListener('keypress', (e)=>{
      if(e.key === 'Enter') searchOrders();
    });
  </script>
</body>
</html>
