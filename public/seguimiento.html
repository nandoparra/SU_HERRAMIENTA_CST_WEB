<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SU HERRAMIENTA CST ‚Äî Seguimiento</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; min-height: 100vh; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: #1d3557;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .hdr-left { display: flex; align-items: center; gap: 12px; }
    .logo-wrap { position: relative; width: 50px; height: 26px; overflow: hidden; flex-shrink: 0; }
    .logo-wrap img { position: absolute; left: 50%; top: 50%; width: 26px;
      transform: translate(-50%,-50%) rotate(-90deg); }
    header h1 { font-size: 15px; font-weight: 600; line-height: 1.3; }
    .hdr-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .hdr-user { font-size: 12px; opacity: .8; }
    .logout-btn {
      background: rgba(255,255,255,0.15);
      border: none; color: #fff;
      padding: 6px 12px; border-radius: 5px;
      cursor: pointer; font-size: 12px; white-space: nowrap;
    }
    .logout-btn:hover { background: rgba(255,255,255,0.25); }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .container { max-width: 680px; margin: 24px auto; padding: 0 14px 40px; }
    .page-title { font-size: 16px; color: #1d3557; font-weight: 700; margin-bottom: 18px; }
    .loading { text-align: center; color: #888; padding: 40px; font-size: 14px; }
    .empty { text-align: center; color: #aaa; padding: 48px 20px; font-size: 14px; }

    /* ‚îÄ‚îÄ Orden card ‚îÄ‚îÄ */
    .orden-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      margin-bottom: 18px;
      overflow: hidden;
    }
    .orden-header {
      padding: 14px 18px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 16px;
      align-items: baseline;
    }
    .orden-num { font-weight: 700; font-size: 15px; color: #1d3557; }
    .orden-meta { font-size: 12px; color: #888; }
    .orden-entrega {
      font-size: 12px; font-weight: 600; color: #1d6a3a;
      background: #e8f5ed; padding: 2px 8px; border-radius: 10px;
    }

    /* ‚îÄ‚îÄ M√°quina item ‚îÄ‚îÄ */
    .maq-item { border-bottom: 1px solid #f5f5f5; }
    .maq-item:last-child { border-bottom: none; }

    .maq-header {
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      transition: background .15s;
    }
    .maq-header:hover { background: #fafafa; }
    .maq-header:active { background: #f5f5f5; }

    .maq-info { flex: 1; min-width: 0; }
    .maq-nombre { font-size: 13px; font-weight: 600; color: #222;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .maq-serial { font-size: 11px; color: #aaa; margin-top: 1px; }

    .maq-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .maq-chevron { font-size: 11px; color: #bbb; transition: transform .2s; }
    .maq-item.open .maq-chevron { transform: rotate(180deg); }

    /* ‚îÄ‚îÄ Estado badges ‚îÄ‚îÄ */
    .estado-badge {
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap;
    }
    .eb-pendiente_revision { background: #888; }
    .eb-revisada           { background: #2196F3; }
    .eb-cotizada           { background: #FF9800; }
    .eb-autorizada         { background: #4CAF50; }
    .eb-no_autorizada      { background: #F44336; }
    .eb-reparada           { background: #9C27B0; }
    .eb-entregada          { background: #009688; }

    /* ‚îÄ‚îÄ Cuerpo expandible ‚îÄ‚îÄ */
    .maq-body {
      display: none;
      padding: 0 18px 16px;
      border-top: 1px solid #f5f5f5;
    }
    .maq-item.open .maq-body { display: block; }

    /* Aviso cotizaci√≥n pendiente */
    .cot-aviso {
      background: #fff8e1; border: 1px solid #ffe082;
      border-radius: 8px; padding: 10px 14px;
      margin: 12px 0 8px;
      display: flex; flex-wrap: wrap;
      align-items: center; gap: 8px;
    }
    .cot-aviso-txt { font-size: 12px; font-weight: 600; color: #795548; flex: 1; }
    .btn-ver-cot {
      background: #FF9800; color: #fff; border: none;
      padding: 5px 12px; border-radius: 5px;
      font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;
    }
    .btn-ver-cot:hover { background: #e68900; }

    /* Secciones internas */
    .sec-block { margin-top: 14px; }
    .sec-lbl {
      font-size: 11px; font-weight: 700; color: #888;
      text-transform: uppercase; letter-spacing: .5px;
      margin-bottom: 6px;
    }
    .obs-text { font-size: 13px; color: #444; line-height: 1.5; white-space: pre-wrap; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 2px; }
    .tl-row {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 4px 0;
    }
    .tl-dot {
      width: 10px; height: 10px; border-radius: 50%;
      flex-shrink: 0; margin-top: 3px;
    }
    .tl-info { flex: 1; }
    .tl-estado { font-size: 12px; font-weight: 600; color: #333; }
    .tl-fecha  { font-size: 11px; color: #aaa; margin-left: 6px; }

    /* Cotizaci√≥n */
    .cot-desc { font-size: 13px; color: #555; line-height: 1.5; margin-bottom: 10px; }
    .cot-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .cot-table td { padding: 5px 4px; vertical-align: top; color: #444; }
    .cot-table .td-num { text-align: right; white-space: nowrap; font-variant-numeric: tabular-nums; }
    .cot-table .td-lbl { color: #666; }
    .cot-table tr.cot-sep td { border-top: 1px solid #eee; }
    .cot-table tr.cot-total td { font-weight: 700; color: #1d3557; }
    .cot-table tr.cot-total .td-num { font-size: 14px; }
    .no-cot { font-size: 12px; color: #aaa; }
    .btn-informe {
      display: inline-block;
      background: #1d3557; color: #fff;
      padding: 7px 14px; border-radius: 6px;
      font-size: 13px; font-weight: 600;
      text-decoration: none;
    }
    .btn-informe:hover { background: #2a4a73; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 520px) {
      header { padding: 11px 14px; gap: 8px; }
      header h1 { font-size: 13px; }
      .hdr-user { display: none; }
      .logout-btn { padding: 7px 10px; }
      .container { padding: 0 10px 32px; }
      .page-title { font-size: 15px; margin-bottom: 14px; }
      .orden-header { padding: 11px 14px; gap: 4px 8px; }
      .orden-num { font-size: 14px; }
      .maq-header { padding: 10px 14px; }
      .maq-body { padding: 0 14px 14px; }
      .cot-aviso { flex-direction: column; align-items: flex-start; gap: 6px; }
      .btn-ver-cot { width: 100%; text-align: center; padding: 10px; }
      .btn-informe { display: block; text-align: center; padding: 11px; }
      .cot-table { font-size: 12px; }
      .cot-table td { padding: 4px 2px; }
      .sec-block { margin-top: 12px; }
      .tl-estado { font-size: 11px; }
      .tl-fecha { font-size: 10px; }
    }
    @media (max-width: 360px) {
      .logo-wrap { display: none; }
      header { gap: 6px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="hdr-left">
      <div class="logo-wrap">
        <img src="/assets/logo.png" alt="Logo">
      </div>
      <h1>SU HERRAMIENTA CST<br><span style="font-weight:400;opacity:.8;font-size:13px;">Seguimiento de √≥rdenes</span></h1>
    </div>
    <div class="hdr-right">
      <span class="hdr-user" id="userName"></span>
      <button class="logout-btn" onclick="logout()">Salir</button>
    </div>
  </header>

  <div class="container">
    <div class="page-title">Mis √≥rdenes de servicio</div>
    <div id="ordenesList" class="loading">Cargando...</div>
  </div>

  <script>
    const ESTADOS = {
      pendiente_revision: { label: 'Pendiente de revisi√≥n', color: '#888' },
      revisada:           { label: 'Revisada',              color: '#2196F3' },
      cotizada:           { label: 'Cotizada',              color: '#FF9800' },
      autorizada:         { label: 'Autorizada',            color: '#4CAF50' },
      no_autorizada:      { label: 'No autorizada',         color: '#F44336' },
      reparada:           { label: 'Reparada',              color: '#9C27B0' },
      entregada:          { label: 'Entregada',             color: '#009688' },
    };

    function esc(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function fmtFecha(raw) {
      if (!raw) return '-';
      const s = String(raw);
      const m8 = s.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (m8) return `${m8[3]}/${m8[2]}/${m8[1]}`;
      const miso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (miso) return `${miso[3]}/${miso[2]}/${miso[1]}`;
      return '-';
    }

    function fmtDatetime(raw) {
      if (!raw) return '-';
      const d = new Date(raw);
      if (isNaN(d)) return '-';
      return d.toLocaleDateString('es-CO', { day:'2-digit', month:'2-digit', year:'numeric' });
    }

    function fmtCop(n) {
      return '$' + Number(n || 0).toLocaleString('es-CO');
    }

    function toggleMaq(el) {
      el.closest('.maq-item').classList.toggle('open');
    }

    function buildMaqHtml(m, maqIdx) {
      const est = ESTADOS[m.her_estado] || ESTADOS.pendiente_revision;
      const badgeClass = 'estado-badge eb-' + (m.her_estado || 'pendiente_revision');

      // Aviso cotizaci√≥n pendiente
      const avisoHtml = (m.her_estado === 'cotizada' && m.cotizacion) ? `
        <div class="cot-aviso">
          <span class="cot-aviso-txt">‚ö†Ô∏è Tiene una cotizaci√≥n pendiente de autorizar</span>
          <button class="btn-ver-cot" onclick="document.getElementById('cot-${maqIdx}').scrollIntoView({behavior:'smooth',block:'nearest'})">Ver cotizaci√≥n ‚Üì</button>
        </div>` : '';

      // Fecha estimada de entrega
      const fechaEnt = m.hor_fecha_prom_entrega
        ? `<div class="sec-block"><div class="sec-lbl">Fecha estimada de entrega</div>
           <div style="font-size:13px;font-weight:600;color:#1d6a3a;">${fmtFecha(m.hor_fecha_prom_entrega)}</div></div>`
        : '';

      // Observaciones
      const obsHtml = m.hor_observaciones ? `
        <div class="sec-block">
          <div class="sec-lbl">Observaciones del t√©cnico</div>
          <div class="obs-text">${esc(m.hor_observaciones)}</div>
        </div>` : '';

      // Historial de estados
      let histHtml = '';
      if (m.historial && m.historial.length) {
        const rows = m.historial.map(h => {
          const est2 = ESTADOS[h.estado] || ESTADOS.pendiente_revision;
          return `<div class="tl-row">
            <div class="tl-dot" style="background:${est2.color}"></div>
            <div class="tl-info">
              <span class="tl-estado">${esc(est2.label)}</span>
              <span class="tl-fecha">${fmtDatetime(h.changed_at)}</span>
            </div>
          </div>`;
        }).join('');
        histHtml = `<div class="sec-block">
          <div class="sec-lbl">Historial de estados</div>
          <div class="timeline">${rows}</div>
        </div>`;
      }

      // Informe de mantenimiento
      const informeHtml = m.informe ? `
        <div class="sec-block">
          <div class="sec-lbl">Informe de mantenimiento</div>
          <a class="btn-informe" href="/api/cliente/informe/${m.uid_herramienta_orden}" target="_blank">
            üìÑ Descargar informe PDF
          </a>
        </div>` : '';

      // Cotizaci√≥n
      let cotHtml = '';
      if (m.cotizacion) {
        const manoObra = Number(m.cotizacion.mano_obra || 0);
        let totalRepuestos = 0;
        let itemRows = '';
        (m.items || []).forEach(it => {
          totalRepuestos += Number(it.subtotal || 0);
          itemRows += `<tr>
            <td class="td-lbl">${esc(it.nombre)} <span style="color:#aaa">(x${it.cantidad})</span></td>
            <td class="td-num">${fmtCop(it.subtotal)}</td>
          </tr>`;
        });
        const total = manoObra + totalRepuestos;
        const descHtml = m.cotizacion.descripcion_trabajo
          ? `<div class="cot-desc">${esc(m.cotizacion.descripcion_trabajo)}</div>` : '';

        cotHtml = `<div class="sec-block" id="cot-${maqIdx}">
          <div class="sec-lbl">Cotizaci√≥n</div>
          ${descHtml}
          <table class="cot-table">
            <tr>
              <td class="td-lbl">Mano de obra</td>
              <td class="td-num">${fmtCop(manoObra)}</td>
            </tr>
            ${itemRows}
            <tr class="cot-sep cot-total">
              <td>Total</td>
              <td class="td-num">${fmtCop(total)}</td>
            </tr>
          </table>
        </div>`;
      } else if (m.her_estado !== 'pendiente_revision') {
        cotHtml = `<div class="sec-block" id="cot-${maqIdx}">
          <div class="sec-lbl">Cotizaci√≥n</div>
          <div class="no-cot">A√∫n no disponible</div>
        </div>`;
      }

      const serial = m.her_serial ? `S/N: ${esc(m.her_serial)}` : '';
      const marca  = m.her_marca  ? esc(m.her_marca) : '';
      const sub    = [marca, serial].filter(Boolean).join(' ¬∑ ');

      return `
        <div class="maq-item" id="maqitem-${maqIdx}">
          <div class="maq-header" onclick="toggleMaq(this)">
            <div class="maq-info">
              <div class="maq-nombre">${esc(m.her_nombre || '-')}</div>
              ${sub ? `<div class="maq-serial">${sub}</div>` : ''}
            </div>
            <div class="maq-right">
              <span class="${badgeClass}">${esc(est.label)}</span>
              <span class="maq-chevron">‚ñº</span>
            </div>
          </div>
          <div class="maq-body">
            ${avisoHtml}
            ${fechaEnt}
            ${obsHtml}
            ${histHtml}
            ${informeHtml}
            ${cotHtml}
          </div>
        </div>`;
    }

    async function init() {
      const me = await fetch('/me').then(r => r.json()).catch(() => ({}));
      if (!me.authenticated) { window.location.href = '/login'; return; }
      document.getElementById('userName').textContent = me.user.nombre;

      const data = await fetch('/api/cliente/mis-ordenes').then(r => r.json()).catch(() => []);
      const el = document.getElementById('ordenesList');

      if (!data.length) {
        el.innerHTML = '<div class="empty">No tienes √≥rdenes de servicio registradas.</div>';
        return;
      }

      let maqCounter = 0;
      el.innerHTML = data.map(orden => {
        // Fecha estimada: tomar la m√°s pr√≥xima no entregada entre las m√°quinas
        const fechasEnt = (orden.maquinas || [])
          .filter(m => m.hor_fecha_prom_entrega && m.her_estado !== 'entregada')
          .map(m => m.hor_fecha_prom_entrega)
          .sort();
        const fechaEntBadge = fechasEnt.length
          ? `<span class="orden-entrega">üìÖ Entrega est. ${fmtFecha(fechasEnt[0])}</span>` : '';

        const maquinasHtml = (orden.maquinas || []).map(m => {
          return buildMaqHtml(m, maqCounter++);
        }).join('');

        return `<div class="orden-card">
          <div class="orden-header">
            <span class="orden-num">Orden #${orden.ord_consecutivo}</span>
            <span class="orden-meta">Ingreso: ${fmtFecha(orden.ord_fecha)}</span>
            ${fechaEntBadge}
          </div>
          ${maquinasHtml || '<div style="padding:12px 18px;font-size:13px;color:#aaa;">Sin equipos registrados</div>'}
        </div>`;
      }).join('');

      // Auto-expand si solo hay una m√°quina en la orden o si tiene aviso
      document.querySelectorAll('.maq-item').forEach(item => {
        if (item.querySelector('.cot-aviso')) item.classList.add('open');
      });
    }

    async function logout() {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    init();
  </script>
</body>
</html>
