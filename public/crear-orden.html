<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SU HERRAMIENTA CST ‚Äî Nueva Orden</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',sans-serif;background:#f0f4f8;min-height:100vh;}
    header{background:#1d3557;color:#fff;padding:13px 24px;display:flex;align-items:center;justify-content:space-between;}
    header h1{font-size:15px;font-weight:600;}
    .nav-links{display:flex;gap:12px;align-items:center;}
    .nav-links a{color:rgba(255,255,255,.8);text-decoration:none;font-size:13px;}
    .nav-links a:hover{color:#fff;}
    .logout-btn{background:rgba(255,255,255,.15);border:none;color:#fff;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:13px;}

    .container{max-width:860px;margin:28px auto;padding:0 16px;}

    /* Steps */
    .steps{display:flex;gap:0;margin-bottom:28px;}
    .step{flex:1;text-align:center;padding:12px 8px;font-size:13px;font-weight:600;color:#aaa;border-bottom:3px solid #ddd;cursor:default;}
    .step.active{color:#1d3557;border-color:#1d3557;}
    .step.done{color:#4CAF50;border-color:#4CAF50;}

    .card{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.07);padding:24px;margin-bottom:16px;}
    h2{font-size:16px;color:#1d3557;margin-bottom:16px;}
    h3{font-size:14px;color:#333;margin-bottom:12px;}

    label{display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;}
    input,select,textarea{width:100%;padding:9px 11px;border:1px solid #ddd;border-radius:6px;font-size:13px;outline:none;transition:border .2s;font-family:inherit;}
    input:focus,select:focus,textarea:focus{border-color:#457b9d;}
    textarea{resize:vertical;min-height:70px;}
    .req{color:#e74c3c;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .form-group{margin-bottom:12px;}

    button{padding:9px 18px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:background .2s;}
    .btn-primary{background:#1d3557;color:#fff;}
    .btn-primary:hover{background:#457b9d;}
    .btn-primary:disabled{background:#aaa;cursor:not-allowed;}
    .btn-secondary{background:#f0f4f8;color:#333;border:1px solid #ddd;}
    .btn-secondary:hover{background:#e2e8f0;}
    .btn-success{background:#4CAF50;color:#fff;}
    .btn-success:hover{background:#388E3C;}
    .btn-danger{background:#e74c3c;color:#fff;padding:5px 10px;font-size:12px;}
    .btn-sm{padding:5px 12px;font-size:12px;}

    .search-row{display:flex;gap:8px;margin-bottom:12px;}
    .search-row input{flex:1;}

    .result-item{padding:10px 14px;border:1px solid #e8e8e8;border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .15s;}
    .result-item:hover{background:#f0f4f8;}
    .result-item.selected{background:#e8f4fd;border-color:#457b9d;}
    .result-name{font-weight:600;font-size:13px;color:#1d3557;}
    .result-sub{font-size:11px;color:#888;margin-top:2px;}

    .selected-client-card{background:#e8f4fd;border:1px solid #457b9d;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
    .selected-client-card .name{font-weight:700;color:#1d3557;font-size:14px;}
    .selected-client-card .sub{font-size:12px;color:#555;margin-top:2px;}

    .maq-item{border:1px solid #e8e8e8;border-radius:8px;padding:14px;margin-bottom:10px;background:#fafafa;}
    .maq-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .maq-nombre{font-weight:700;font-size:13px;color:#1d3557;}
    .maq-sub{font-size:11px;color:#888;}

    .foto-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .foto-thumb{position:relative;width:80px;height:80px;border-radius:6px;overflow:hidden;border:1px solid #ddd;}
    .foto-thumb img{width:100%;height:100%;object-fit:cover;}
    .foto-thumb .del{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

    .divider{border:none;border-top:1px solid #eee;margin:16px 0;}
    .alert{padding:10px 14px;border-radius:6px;font-size:13px;margin-bottom:12px;}
    .alert-error{background:#fdecea;color:#c0392b;}
    .alert-success{background:#e8f5e9;color:#2e7d32;}
    .muted{font-size:12px;color:#888;}
    .tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;}

    .section-toggle{background:none;border:none;color:#1d3557;font-size:13px;font-weight:600;cursor:pointer;padding:0;text-decoration:underline;}

    .order-success{text-align:center;padding:32px;}
    .order-success .num{font-size:48px;font-weight:800;color:#1d3557;}
    .order-success .label{font-size:15px;color:#666;margin-bottom:20px;}
    .order-success .maq-list{text-align:left;max-width:400px;margin:0 auto 24px;}
  </style>
</head>
<body>

<header>
  <h1>üîß SU HERRAMIENTA CST ‚Äî Nueva Orden de Servicio</h1>
  <div class="nav-links">
    <a href="/generador-cotizaciones.html">‚Üê Cotizaciones</a>
    <a href="/ordenes.html">√ìrdenes</a>
    <span id="headerUser" style="font-size:13px;opacity:.8;"></span>
    <button class="logout-btn" onclick="doLogout()">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="container">

  <!-- Steps -->
  <div class="steps">
    <div class="step active" id="step1-tab">1. Cliente</div>
    <div class="step" id="step2-tab">2. M√°quinas</div>
    <div class="step" id="step3-tab">3. Confirmar</div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 1: CLIENTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="step1">
    <div class="card">
      <h2>Buscar cliente</h2>
      <div class="search-row">
        <input id="clientSearch" type="text" placeholder="C√©dula, NIT, nombre o tel√©fono..." oninput="buscarCliente()">
      </div>
      <div id="clientResults"></div>

      <div id="selectedClientCard" style="display:none;"></div>

      <hr class="divider">
      <button class="section-toggle" onclick="toggleNewClient()">+ Crear nuevo cliente</button>

      <div id="newClientForm" style="display:none;margin-top:16px;">
        <h3>Nuevo cliente</h3>
        <div class="grid2">
          <div class="form-group">
            <label>Identificaci√≥n <span class="req">*</span></label>
            <input id="nc_id" type="text" placeholder="C√©dula o NIT" inputmode="numeric"
              oninput="this.value=this.value.replace(/[^0-9]/g,'')" onblur="sugerirClave()">
          </div>
          <div class="form-group">
            <label>Raz√≥n Social <span class="req">*</span></label>
            <input id="nc_nombre" type="text" placeholder="Nombre o empresa">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label>Tel√©fono <span class="req">*</span></label>
            <input id="nc_tel" type="text" inputmode="numeric" placeholder="Tel√©fono"
              oninput="this.value=this.value.replace(/[^0-9\s\/\-]/g,'')">
          </div>
          <div class="form-group">
            <label>Direcci√≥n</label>
            <input id="nc_dir" type="text" placeholder="Direcci√≥n">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label>Contacto</label>
            <input id="nc_contacto" type="text" placeholder="Nombre del contacto">
          </div>
          <div class="form-group">
            <label>Tel√©fono Contacto</label>
            <input id="nc_tel_contacto" type="text" inputmode="numeric" placeholder="Tel√©fono contacto"
              oninput="this.value=this.value.replace(/[^0-9\s\/\-]/g,'')">
          </div>
        </div>
        <div class="form-group" style="max-width:200px;">
          <label>Clave asignada <span class="req">*</span></label>
          <input id="nc_clave" type="text" placeholder="√öltimos 4 d√≠gitos">
          <div class="muted" style="margin-top:4px;">Por defecto: √∫ltimos 4 d√≠gitos de la identificaci√≥n</div>
        </div>
        <div id="newClientError" class="alert alert-error" style="display:none;"></div>
        <button class="btn-primary" onclick="crearCliente()">Crear cliente</button>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;">
      <button class="btn-primary" id="btnStep1Next" onclick="goStep2()" disabled>Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 2: M√ÅQUINAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="step2" style="display:none;">
    <div class="card">
      <div id="step2ClientCard"></div>

      <h2>M√°quinas en esta orden</h2>

      <!-- Historial -->
      <h3>Historial del cliente</h3>
      <div id="herramientasHistorial" class="muted">Cargando...</div>

      <hr class="divider">

      <!-- Nueva m√°quina -->
      <button class="section-toggle" onclick="toggleNewMaq()">+ Agregar m√°quina nueva</button>
      <div id="newMaqForm" style="display:none;margin-top:14px;">
        <div class="grid2">
          <div class="form-group">
            <label>Nombre <span class="req">*</span></label>
            <input id="nm_nombre" type="text" placeholder="Ej: Taladro, Esmeril...">
          </div>
          <div class="form-group">
            <label>Marca</label>
            <input id="nm_marca" type="text" placeholder="Ej: Bosch, DeWalt...">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label>Serial</label>
            <input id="nm_serial" type="text" placeholder="N√∫mero de serie">
          </div>
          <div class="form-group">
            <label>Referencia</label>
            <input id="nm_ref" type="text" placeholder="Referencia del modelo">
          </div>
        </div>
        <div id="newMaqError" class="alert alert-error" style="display:none;"></div>
        <button class="btn-primary" onclick="crearMaquina()">Agregar a la orden</button>
      </div>
    </div>

    <!-- Lista de m√°quinas agregadas -->
    <div id="maquinasEnOrden"></div>

    <div style="display:flex;justify-content:space-between;margin-top:8px;">
      <button class="btn-secondary" onclick="goStep1()">‚Üê Atr√°s</button>
      <button class="btn-primary" id="btnStep2Next" onclick="goStep3()" disabled>Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STEP 3: CONFIRMAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="step3" style="display:none;">
    <div class="card">
      <h2>Confirmar orden</h2>
      <div id="resumenOrden"></div>
      <div id="step3Error" class="alert alert-error" style="display:none;"></div>
    </div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn-secondary" onclick="goStep2()">‚Üê Atr√°s</button>
      <button class="btn-success" id="btnCrear" onclick="crearOrden()">‚úì Crear Orden</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê √âXITO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="stepSuccess" style="display:none;">
    <div class="card order-success">
      <div style="font-size:40px;">‚úÖ</div>
      <div class="num" id="successConsecutivo"></div>
      <div class="label">Orden creada exitosamente</div>

      <div class="maq-list" id="successMaqList"></div>

        <div id="ordenAcciones"></div>

      <hr class="divider">
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
        <button class="btn-primary" onclick="window.location.href='/generador-cotizaciones.html'">Ir a Cotizaciones</button>
        <button class="btn-secondary" onclick="nuevaOrden()">Nueva Orden</button>
      </div>
    </div>
  </div>

</div>

<script>
const API = '/api';
let clienteSeleccionado = null;
let maquinasEnOrden = []; // [{ uid_herramienta, her_nombre, her_marca, her_serial, observaciones, fotos:[] }]
let ordenCreada = null;
let clientMap = {};
let herramientaMap = {};

// ‚îÄ‚îÄ Sesi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function() {
  const me = await fetch('/me').then(r => r.json()).catch(() => ({}));
  if (!me.authenticated) { window.location.href = '/login'; return; }
  document.getElementById('headerUser').textContent = me.user.nombre;
})();

async function doLogout() {
  await fetch('/logout', { method: 'POST' });
  window.location.href = '/login';
}

// ‚îÄ‚îÄ Steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStep(n) {
  ['step1','step2','step3','stepSuccess'].forEach((id,i) => {
    document.getElementById(id).style.display = (i === n-1 || (n===4 && i===3)) ? 'block' : 'none';
  });
  [1,2,3].forEach(i => {
    const t = document.getElementById(`step${i}-tab`);
    if (!t) return;
    t.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
  });
}

function goStep1() { setStep(1); }

async function goStep2() {
  if (!clienteSeleccionado) return;
  setStep(2);
  document.getElementById('step2ClientCard').innerHTML = `
    <div class="selected-client-card" style="margin-bottom:16px;">
      <div><div class="name">${clienteSeleccionado.cli_razon_social}</div>
      <div class="sub">NIT/CC: ${clienteSeleccionado.cli_identificacion} | Tel: ${clienteSeleccionado.cli_telefono||'-'}</div></div>
    </div>`;
  await cargarHistorial();
  renderMaquinasEnOrden();
}

function goStep3() {
  if (!maquinasEnOrden.length) return;
  setStep(3);
  renderResumen();
}

// ‚îÄ‚îÄ Cliente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let buscarTimer = null;
function buscarCliente() {
  clearTimeout(buscarTimer);
  buscarTimer = setTimeout(async () => {
    const q = document.getElementById('clientSearch').value.trim();
    if (q.length < 2) { document.getElementById('clientResults').innerHTML = ''; return; }
    const data = await fetch(`${API}/crear-orden/cliente/buscar?q=${encodeURIComponent(q)}`).then(r => r.json());
    const el = document.getElementById('clientResults');
    if (!data.length) { el.innerHTML = '<div class="muted">No se encontraron clientes.</div>'; return; }
    data.forEach(c => { clientMap[c.uid_cliente] = c; });
    el.innerHTML = data.map(c => `
      <div class="result-item" onclick="seleccionarCliente(${c.uid_cliente})">
        <div>
          <div class="result-name">${c.cli_razon_social}</div>
          <div class="result-sub">CC/NIT: ${c.cli_identificacion} | Tel: ${c.cli_telefono||'-'}</div>
        </div>
        <button class="btn-primary btn-sm">Seleccionar</button>
      </div>`).join('');
  }, 300);
}

function seleccionarCliente(uid) {
  const c = clientMap[uid];
  clienteSeleccionado = c;
  document.getElementById('clientResults').innerHTML = '';
  document.getElementById('clientSearch').value = '';
  document.getElementById('newClientForm').style.display = 'none';
  document.getElementById('selectedClientCard').style.display = 'block';
  document.getElementById('selectedClientCard').innerHTML = `
    <div class="selected-client-card">
      <div>
        <div class="name">${c.cli_razon_social}</div>
        <div class="sub">CC/NIT: ${c.cli_identificacion} | Tel: ${c.cli_telefono||'-'} | ${c.cli_direccion||''}</div>
      </div>
      <button class="btn-secondary btn-sm" onclick="deseleccionarCliente()">Cambiar</button>
    </div>`;
  document.getElementById('btnStep1Next').disabled = false;
}

function deseleccionarCliente() {
  clienteSeleccionado = null;
  document.getElementById('selectedClientCard').style.display = 'none';
  document.getElementById('selectedClientCard').innerHTML = '';
  document.getElementById('btnStep1Next').disabled = true;
}

function toggleNewClient() {
  const f = document.getElementById('newClientForm');
  f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function sugerirClave() {
  const id = document.getElementById('nc_id').value;
  if (id.length >= 4) document.getElementById('nc_clave').value = id.slice(-4);
}

async function crearCliente() {
  const errEl = document.getElementById('newClientError');
  errEl.style.display = 'none';
  const body = {
    cli_identificacion: document.getElementById('nc_id').value.trim(),
    cli_razon_social:   document.getElementById('nc_nombre').value.trim(),
    cli_telefono:       document.getElementById('nc_tel').value.trim(),
    cli_direccion:      document.getElementById('nc_dir').value.trim(),
    cli_contacto:       document.getElementById('nc_contacto').value.trim(),
    cli_tel_contacto:   document.getElementById('nc_tel_contacto').value.trim(),
    clave:              document.getElementById('nc_clave').value.trim(),
  };
  const res = await fetch(`${API}/crear-orden/cliente`, {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
  }).then(r => r.json());
  if (!res.success) { errEl.textContent = res.error; errEl.style.display = 'block'; return; }
  clientMap[res.cliente.uid_cliente] = res.cliente;
  seleccionarCliente(res.cliente.uid_cliente);
  document.getElementById('newClientForm').style.display = 'none';
}

// ‚îÄ‚îÄ M√°quinas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarHistorial() {
  const el = document.getElementById('herramientasHistorial');
  el.innerHTML = 'Cargando...';
  const data = await fetch(`${API}/crear-orden/herramientas/${clienteSeleccionado.uid_cliente}`).then(r => r.json());
  if (!data.length) { el.innerHTML = '<div class="muted">Este cliente no tiene m√°quinas previas.</div>'; return; }
  data.forEach(h => { herramientaMap[h.uid_herramienta] = h; });
  el.innerHTML = data.map(h => `
    <div class="result-item" onclick="agregarMaquina(${h.uid_herramienta})">
      <div>
        <div class="result-name">${h.her_nombre} ${h.her_marca||''}</div>
        <div class="result-sub">${h.her_serial ? 'S/N: '+h.her_serial : ''}${h.her_referencia ? ' | Ref: '+h.her_referencia : ''}</div>
      </div>
      <button class="btn-primary btn-sm">Agregar</button>
    </div>`).join('');
}

function agregarMaquina(uid) {
  const h = herramientaMap[uid];
  if (maquinasEnOrden.find(m => m.uid_herramienta === h.uid_herramienta)) {
    alert('Esta m√°quina ya est√° en la orden.');
    return;
  }
  maquinasEnOrden.push({ ...h, observaciones: '', fotos: [] });
  renderMaquinasEnOrden();
}

function toggleNewMaq() {
  const f = document.getElementById('newMaqForm');
  f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

async function crearMaquina() {
  const errEl = document.getElementById('newMaqError');
  errEl.style.display = 'none';
  const body = {
    uid_cliente:   clienteSeleccionado.uid_cliente,
    her_nombre:    document.getElementById('nm_nombre').value.trim(),
    her_marca:     document.getElementById('nm_marca').value.trim(),
    her_serial:    document.getElementById('nm_serial').value.trim(),
    her_referencia:document.getElementById('nm_ref').value.trim(),
  };
  if (!body.her_nombre) { errEl.textContent = 'El nombre es obligatorio'; errEl.style.display = 'block'; return; }
  const res = await fetch(`${API}/crear-orden/herramienta`, {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
  }).then(r => r.json());
  if (!res.success) { errEl.textContent = res.error; errEl.style.display = 'block'; return; }
  maquinasEnOrden.push({ ...res.herramienta, observaciones: '', fotos: [] });
  renderMaquinasEnOrden();
  // limpiar form
  ['nm_nombre','nm_marca','nm_serial','nm_ref'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('newMaqForm').style.display = 'none';
  await cargarHistorial();
}

function quitarMaquina(uid) {
  maquinasEnOrden = maquinasEnOrden.filter(m => m.uid_herramienta !== uid);
  renderMaquinasEnOrden();
}

function setObservacion(uid, val) {
  const m = maquinasEnOrden.find(m => m.uid_herramienta === uid);
  if (m) m.observaciones = val;
}

function renderMaquinasEnOrden() {
  const el = document.getElementById('maquinasEnOrden');
  document.getElementById('btnStep2Next').disabled = maquinasEnOrden.length === 0;
  if (!maquinasEnOrden.length) { el.innerHTML = '<div class="muted" style="margin-bottom:12px;">Ninguna m√°quina agregada a√∫n.</div>'; return; }
  el.innerHTML = maquinasEnOrden.map((m, i) => `
    <div class="card maq-item">
      <div class="maq-header">
        <div>
          <div class="maq-nombre">${i+1}. ${m.her_nombre} ${m.her_marca||''}</div>
          <div class="maq-sub">${m.her_serial ? 'S/N: '+m.her_serial : 'Sin serial'}${m.her_referencia ? ' | Ref: '+m.her_referencia : ''}</div>
        </div>
        <button class="btn-danger" onclick="quitarMaquina(${m.uid_herramienta})">Quitar</button>
      </div>
      <div class="form-group">
        <label>Observaciones de recepci√≥n</label>
        <textarea placeholder="Estado visible, accesorios entregados, falla reportada..." onchange="setObservacion(${m.uid_herramienta}, this.value)">${m.observaciones||''}</textarea>
      </div>
      <div class="form-group" style="margin-top:8px;">
        <label>Fotos de recepci√≥n</label>
        <div class="foto-preview" id="fotoPreview_${m.uid_herramienta}"></div>
        <label style="display:inline-block;margin-top:6px;padding:6px 12px;background:#f0f4f8;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:12px;">
          üì∑ Agregar fotos
          <input type="file" accept="image/*" multiple style="display:none;"
            onchange="agregarFotosPreview(${m.uid_herramienta}, this.files)">
        </label>
        <span class="muted" style="margin-left:8px;" id="fotoCount_${m.uid_herramienta}"></span>
      </div>
    </div>`).join('');
  // Re-renderizar previews en memoria
  maquinasEnOrden.forEach(m => renderFotoPreviews(m.uid_herramienta));
}

// ‚îÄ‚îÄ Fotos en preview (Step 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agregarFotosPreview(uid, files) {
  const m = maquinasEnOrden.find(m => m.uid_herramienta === uid);
  if (!m) return;
  Array.from(files).forEach(f => {
    m.fotos.push({ file: f, url: URL.createObjectURL(f) });
  });
  renderFotoPreviews(uid);
}

function quitarFotoPreview(uid, idx) {
  const m = maquinasEnOrden.find(m => m.uid_herramienta === uid);
  if (!m) return;
  URL.revokeObjectURL(m.fotos[idx].url);
  m.fotos.splice(idx, 1);
  renderFotoPreviews(uid);
}

function renderFotoPreviews(uid) {
  const m = maquinasEnOrden.find(m => m.uid_herramienta === uid);
  const previewEl = document.getElementById('fotoPreview_' + uid);
  const countEl   = document.getElementById('fotoCount_'   + uid);
  if (!m || !previewEl) return;
  previewEl.innerHTML = m.fotos.map((f, i) => `
    <div class="foto-thumb">
      <img src="${f.url}" alt="foto">
      <button class="del" onclick="quitarFotoPreview(${uid}, ${i})" title="Quitar">√ó</button>
    </div>`).join('');
  if (countEl) countEl.textContent = m.fotos.length ? m.fotos.length + ' foto(s)' : '';
}

// ‚îÄ‚îÄ Resumen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResumen() {
  document.getElementById('resumenOrden').innerHTML = `
    <div class="selected-client-card" style="margin-bottom:16px;">
      <div>
        <div class="name">${clienteSeleccionado.cli_razon_social}</div>
        <div class="sub">CC/NIT: ${clienteSeleccionado.cli_identificacion} | Tel: ${clienteSeleccionado.cli_telefono||'-'}</div>
      </div>
    </div>
    <h3 style="margin-bottom:10px;">M√°quinas (${maquinasEnOrden.length})</h3>
    ${maquinasEnOrden.map((m,i) => `
      <div style="padding:8px 12px;border:1px solid #eee;border-radius:6px;margin-bottom:6px;">
        <div style="font-weight:600;font-size:13px;">${i+1}. ${m.her_nombre} ${m.her_marca||''}</div>
        ${m.her_serial ? `<div class="muted">S/N: ${m.her_serial}</div>` : ''}
        ${m.observaciones ? `<div class="muted" style="margin-top:4px;">${m.observaciones}</div>` : ''}
        ${m.fotos.length ? `<div class="muted" style="margin-top:2px;">üì∑ ${m.fotos.length} foto(s) adjunta(s)</div>` : ''}
      </div>`).join('')}`;
}

// ‚îÄ‚îÄ Crear orden ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function crearOrden() {
  const btn = document.getElementById('btnCrear');
  const errEl = document.getElementById('step3Error');
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Creando...';

  const res = await fetch(`${API}/crear-orden/orden`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      uid_cliente: clienteSeleccionado.uid_cliente,
      maquinas: maquinasEnOrden.map(m => ({ uid_herramienta: m.uid_herramienta, observaciones: m.observaciones })),
    }),
  }).then(r => r.json());

  btn.disabled = false;
  btn.textContent = '‚úì Crear Orden';

  if (!res.success) { errEl.textContent = res.error; errEl.style.display = 'block'; return; }
  ordenCreada = res;

  // Subir fotos adjuntadas en Step 2
  btn.disabled = true;
  btn.textContent = 'Subiendo fotos...';
  for (let i = 0; i < res.herramientas.length; i++) {
    const fotos = maquinasEnOrden[i]?.fotos || [];
    for (const f of fotos) {
      const fd = new FormData();
      fd.append('foto', f.file);
      await fetch(`${API}/crear-orden/foto/${res.herramientas[i].uid_herramienta_orden}`, { method: 'POST', body: fd });
    }
  }
  btn.disabled = false;
  btn.textContent = '‚úì Crear Orden';

  mostrarExito();
}

// ‚îÄ‚îÄ √âxito + fotos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarExito() {
  setStep(4);
  document.getElementById('successConsecutivo').textContent = `Orden #${ordenCreada.ord_consecutivo}`;
  document.getElementById('successMaqList').innerHTML = maquinasEnOrden.map((m,i) => `
    <div style="padding:6px 0;border-bottom:1px solid #eee;font-size:13px;">
      ${i+1}. ${m.her_nombre} ${m.her_marca||''}${m.her_serial ? ' / S/N: '+m.her_serial : ''}
    </div>`).join('');

  const accionesEl = document.getElementById('ordenAcciones');
  const uid_orden = ordenCreada.uid_orden;
  accionesEl.innerHTML = `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
      <a href="${API}/orders/${uid_orden}/print/orden" target="_blank"
         style="padding:9px 20px;background:#1d3557;color:#fff;border-radius:6px;font-size:13px;font-weight:600;text-decoration:none;">
        üñ®Ô∏è Imprimir orden
      </a>
      <button onclick="enviarOrdenWA(${uid_orden}, this)"
         style="padding:9px 20px;background:#25D366;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
        üì± Enviar por WhatsApp
      </button>
    </div>`;
}

async function enviarOrdenWA(uid_orden, btn) {
  const orig = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Enviando...';
  try {
    const res = await fetch(`${API}/orders/${uid_orden}/send-pdf/orden`, { method: 'POST' }).then(r => r.json());
    btn.textContent = res.success ? '‚úì Enviado' : '‚úó Error';
    if (!res.success) setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
  } catch {
    btn.textContent = '‚úó Error';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 3000);
  }
}

function nuevaOrden() {
  maquinasEnOrden.forEach(m => m.fotos.forEach(f => URL.revokeObjectURL(f.url)));
  clienteSeleccionado = null;
  maquinasEnOrden = [];
  ordenCreada = null;
  document.getElementById('clientSearch').value = '';
  document.getElementById('clientResults').innerHTML = '';
  document.getElementById('selectedClientCard').style.display = 'none';
  document.getElementById('btnStep1Next').disabled = true;
  setStep(1);
}
</script>
</body>
</html>
