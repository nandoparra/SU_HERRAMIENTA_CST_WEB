<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SU HERRAMIENTA CST ‚Äî √ìrdenes</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',sans-serif;background:#f0f4f8;min-height:100vh;display:flex;flex-direction:column;}

    header{background:#1d3557;color:#fff;padding:13px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    header h1{font-size:15px;font-weight:600;}
    .nav-links{display:flex;gap:12px;align-items:center;}
    .nav-links a{color:rgba(255,255,255,.8);text-decoration:none;font-size:13px;}
    .nav-links a:hover{color:#fff;}
    .logout-btn{background:rgba(255,255,255,.15);border:none;color:#fff;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:13px;}

    .main{display:flex;flex:1;gap:0;min-height:0;}

    /* ‚îÄ‚îÄ‚îÄ Panel izquierdo ‚îÄ‚îÄ‚îÄ */
    .panel-left{width:340px;min-width:280px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;flex-shrink:0;}
    .search-box{padding:16px;border-bottom:1px solid #eee;}
    .search-box h2{font-size:13px;font-weight:700;color:#1d3557;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;}

    .concept-row{display:flex;gap:6px;margin-bottom:8px;}
    .concept-row select{flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;color:#333;background:#fff;outline:none;}
    .concept-row select:focus{border-color:#457b9d;}

    .input-row{display:flex;gap:6px;}
    .input-row input{flex:1;padding:9px 11px;border:1px solid #ddd;border-radius:6px;font-size:13px;outline:none;}
    .input-row input:focus{border-color:#457b9d;}
    .input-row button{padding:9px 14px;background:#1d3557;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
    .input-row button:hover{background:#457b9d;}

    .results-list{flex:1;overflow-y:auto;padding:10px;}
    .results-empty{padding:20px 14px;text-align:center;color:#aaa;font-size:13px;}

    .result-card{padding:11px 14px;border:1px solid #e8e8e8;border-radius:8px;margin-bottom:7px;cursor:pointer;transition:background .15s,border-color .15s;}
    .result-card:hover{background:#f0f4f8;border-color:#457b9d;}
    .result-card.active{background:#e8f4fd;border-color:#1d3557;}
    .rc-top{display:flex;justify-content:space-between;align-items:center;}
    .rc-num{font-weight:700;font-size:13px;color:#1d3557;}
    .rc-fecha{font-size:11px;color:#999;}
    .rc-cliente{font-size:12px;color:#333;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .rc-maq{font-size:11px;color:#888;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* ‚îÄ‚îÄ‚îÄ Panel derecho ‚îÄ‚îÄ‚îÄ */
    .panel-right{flex:1;overflow-y:auto;padding:24px;}

    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#aaa;text-align:center;}
    .empty-state .icon{font-size:48px;margin-bottom:12px;opacity:.4;}
    .empty-state p{font-size:14px;}

    .orden-header{display:flex;align-items:baseline;gap:12px;margin-bottom:16px;}
    .orden-num{font-size:22px;font-weight:800;color:#1d3557;}
    .orden-fecha{font-size:13px;color:#888;}

    .card{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:18px;margin-bottom:14px;}
    .card-title{font-size:12px;font-weight:700;color:#457b9d;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;}

    .client-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;}
    .field{font-size:12px;}
    .field .lbl{color:#888;font-size:11px;display:block;margin-bottom:1px;}
    .field .val{color:#1d3557;font-weight:600;}

    .maq-card{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px;margin-bottom:10px;}
    .maq-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
    .maq-nombre{font-weight:700;font-size:14px;color:#1d3557;}
    .maq-sub{font-size:11px;color:#888;margin-top:2px;}

    .badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;color:#fff;}
    .b-pendiente_revision{background:#888;}
    .b-revisada{background:#457b9d;}
    .b-cotizada{background:#6c3483;}
    .b-autorizada{background:#27ae60;}
    .b-no_autorizada{background:#e74c3c;}
    .b-reparada{background:#16a085;}
    .b-entregada{background:#1e8449;}

    .maq-obs{font-size:12px;color:#555;margin-top:8px;padding:8px 10px;background:#f7f9fb;border-radius:6px;border-left:3px solid #ddd;}
    .maq-obs-lbl{font-size:10px;font-weight:700;color:#aaa;text-transform:uppercase;margin-bottom:3px;}

    .foto-row{display:flex;flex-wrap:wrap;gap:7px;margin-top:10px;}
    .foto-thumb{width:72px;height:72px;border-radius:6px;overflow:hidden;border:1px solid #ddd;cursor:pointer;flex-shrink:0;}
    .foto-thumb img{width:100%;height:100%;object-fit:cover;}
    .foto-thumb:hover{border-color:#457b9d;transform:scale(1.04);transition:transform .15s;}
    .sin-fotos{font-size:11px;color:#aaa;margin-top:8px;}

    .cot-section{margin-top:12px;padding-top:10px;border-top:1px dashed #e2e8f0;}
    .cot-title{font-size:10px;font-weight:700;color:#6c3483;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
    .cot-row{display:flex;justify-content:space-between;font-size:12px;color:#333;padding:3px 0;}
    .cot-row .lbl{color:#666;}
    .cot-row .val{font-weight:600;color:#1d3557;}
    .cot-items{margin:6px 0 4px 8px;}
    .cot-item{font-size:11px;color:#555;padding:2px 0;}
    .cot-item::before{content:'‚Ä¢ ';color:#aaa;}
    .cot-subtotal{display:flex;justify-content:space-between;font-size:12px;font-weight:700;color:#1d3557;padding:4px 0;border-top:1px solid #eee;margin-top:4px;}

    .total-card{background:#1d3557;border-radius:10px;padding:16px 20px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
    .total-card .tc-item{text-align:center;}
    .total-card .tc-lbl{font-size:10px;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;}
    .total-card .tc-val{font-size:16px;font-weight:800;color:#fff;}
    .total-card .tc-val.big{font-size:22px;}

    .acciones{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;}
    .btn-print{padding:9px 18px;background:#1d3557;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;}
    .btn-print:hover{background:#457b9d;}
    .btn-quote{padding:9px 18px;background:#4CAF50;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;}
    .btn-quote:hover{background:#388E3C;}
    .btn-quote-ver{padding:9px 18px;background:#6c3483;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;}
    .btn-quote-ver:hover{background:#5b2c6f;}

    .loading{text-align:center;padding:20px;color:#888;font-size:13px;}

    @media(max-width:700px){
      .main{flex-direction:column;}
      .panel-left{width:100%;min-width:unset;border-right:none;border-bottom:1px solid #e2e8f0;max-height:320px;}
    }
  </style>
</head>
<body>

<header>
  <h1>üîß SU HERRAMIENTA CST ‚Äî √ìrdenes de Servicio</h1>
  <div class="nav-links">
    <a href="/generador-cotizaciones.html">Cotizaciones</a>
    <a href="/crear-orden.html">+ Nueva Orden</a>
    <span id="headerUser" style="font-size:13px;opacity:.8;"></span>
    <button class="logout-btn" onclick="doLogout()">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="main">

  <!-- ‚îÄ‚îÄ‚îÄ Panel izquierdo: buscador + resultados ‚îÄ‚îÄ‚îÄ -->
  <div class="panel-left">
    <div class="search-box">
      <h2>Buscar orden</h2>
      <div class="concept-row">
        <select id="conceptoSelect" onchange="actualizarPlaceholder()">
          <option value="consecutivo">N√∫mero de orden</option>
          <option value="cedula">C√©dula / NIT</option>
          <option value="nombre">Nombre del cliente</option>
        </select>
      </div>
      <div class="input-row">
        <input id="searchInput" type="text" placeholder="Ej: 7833" oninput="buscarDebounce()">
        <button onclick="buscar()">üîç</button>
      </div>
    </div>
    <div class="results-list" id="resultsList">
      <div class="results-empty">Escribe para buscar</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Panel derecho: detalle ‚îÄ‚îÄ‚îÄ -->
  <div class="panel-right" id="panelRight">
    <div class="empty-state">
      <div class="icon">üìã</div>
      <p>Selecciona una orden para ver el detalle</p>
    </div>
  </div>

</div>

<script>
const API = '/api';
let buscarTimer = null;
let ordenActiva = null;

const PLACEHOLDERS = {
  consecutivo: 'Ej: 7833',
  cedula:      'Ej: 8914110164',
  nombre:      'Ej: Motel Casa Blanca',
};

const ESTADO_LABELS = {
  pendiente_revision: 'Pendiente revisi√≥n',
  revisada:           'Revisada',
  cotizada:           'Cotizada',
  autorizada:         'Autorizada',
  no_autorizada:      'No autorizada',
  reparada:           'Reparada',
  entregada:          'Entregada',
};

// ‚îÄ‚îÄ Sesi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function() {
  const me = await fetch('/me').then(r => r.json()).catch(() => ({}));
  if (!me.authenticated) { window.location.href = '/login'; return; }
  document.getElementById('headerUser').textContent = me.user.nombre;
})();

async function doLogout() {
  await fetch('/logout', { method: 'POST' });
  window.location.href = '/login';
}

// ‚îÄ‚îÄ B√∫squeda ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function actualizarPlaceholder() {
  const concepto = document.getElementById('conceptoSelect').value;
  document.getElementById('searchInput').placeholder = PLACEHOLDERS[concepto];
  document.getElementById('searchInput').value = '';
  document.getElementById('resultsList').innerHTML = '<div class="results-empty">Escribe para buscar</div>';
}

function buscarDebounce() {
  clearTimeout(buscarTimer);
  buscarTimer = setTimeout(buscar, 350);
}

async function buscar() {
  const q = document.getElementById('searchInput').value.trim();
  if (q.length < 1) {
    document.getElementById('resultsList').innerHTML = '<div class="results-empty">Escribe para buscar</div>';
    return;
  }
  document.getElementById('resultsList').innerHTML = '<div class="loading">Buscando...</div>';
  const data = await fetch(`${API}/orders/search?q=${encodeURIComponent(q)}`).then(r => r.json()).catch(() => []);
  renderResultados(data);
}

function fmtFecha(raw) {
  const m = String(raw || '').match(/^(\d{4})(\d{2})(\d{2})$/);
  return m ? `${m[3]}/${m[2]}/${m[1]}` : (raw || '-');
}

function renderResultados(data) {
  const el = document.getElementById('resultsList');
  if (!data.length) { el.innerHTML = '<div class="results-empty">Sin resultados</div>'; return; }
  el.innerHTML = data.map(o => `
    <div class="result-card${ordenActiva === o.uid_orden ? ' active' : ''}" onclick="verDetalle(${o.uid_orden})">
      <div class="rc-top">
        <span class="rc-num">Orden #${o.ord_consecutivo}</span>
        <span class="rc-fecha">${fmtFecha(o.ord_fecha)}</span>
      </div>
      <div class="rc-cliente">${o.cli_razon_social || ''}</div>
      <div class="rc-maq">${o.maquinas_resumen || (o.maquinas ? o.maquinas + ' m√°quina(s)' : '')}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ Detalle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function verDetalle(uid_orden) {
  ordenActiva = uid_orden;
  // resaltar activo en lista
  document.querySelectorAll('.result-card').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.result-card').forEach(el => {
    if (el.onclick.toString().includes(`(${uid_orden})`)) el.classList.add('active');
  });

  const panel = document.getElementById('panelRight');
  panel.innerHTML = '<div class="loading">Cargando detalle...</div>';

  const data = await fetch(`${API}/orders/${uid_orden}/detalle`).then(r => r.json()).catch(e => ({ error: e.message }));
  if (data.error) { panel.innerHTML = `<div class="loading" style="color:#e74c3c;">Error: ${data.error}</div>`; return; }

  const { orden, maquinas, tieneCotizacion, cotOrden } = data;

  panel.innerHTML = `
    <div class="orden-header">
      <span class="orden-num">Orden #${orden.ord_consecutivo}</span>
      <span class="orden-fecha">${fmtFecha(orden.ord_fecha)}</span>
    </div>

    <!-- Cliente -->
    <div class="card">
      <div class="card-title">Cliente</div>
      <div class="client-grid">
        <div class="field"><span class="lbl">Nombre / Raz√≥n social</span><span class="val">${orden.cli_razon_social || '-'}</span></div>
        <div class="field"><span class="lbl">C√©dula / NIT</span><span class="val">${orden.cli_identificacion || '-'}</span></div>
        <div class="field"><span class="lbl">Tel√©fono</span><span class="val">${orden.cli_telefono || '-'}</span></div>
        <div class="field"><span class="lbl">Direcci√≥n</span><span class="val">${orden.cli_direccion || '-'}</span></div>
      </div>
    </div>

    <!-- M√°quinas -->
    <div class="card">
      <div class="card-title">Equipos (${maquinas.length})</div>
      ${maquinas.map(m => renderMaquina(m, orden)).join('')}
    </div>

    <!-- Total cotizaci√≥n -->
    ${cotOrden ? renderTotalCotizacion(cotOrden) : ''}

    <!-- Acciones generales -->
    <div class="acciones">
      <a class="btn-print" href="${API}/orders/${orden.uid_orden}/print/orden" target="_blank">üñ®Ô∏è Imprimir orden</a>
      ${!tieneCotizacion
        ? `<a class="btn-quote" href="/generador-cotizaciones.html?orden=${orden.uid_orden}" target="_blank">‚úèÔ∏è Cotizar</a>`
        : ''
      }
    </div>`;
}

const money = n => '$' + Number(n || 0).toLocaleString('es-CO');

function renderMaquina(m, orden) {
  const estadoLabel = ESTADO_LABELS[m.her_estado] || m.her_estado || '-';
  const badgeClass  = 'badge b-' + (m.her_estado || 'pendiente_revision');

  const subParts = [
    m.her_marca      ? m.her_marca                  : null,
    m.her_serial     ? 'S/N: ' + m.her_serial       : null,
    m.her_referencia ? 'Ref: ' + m.her_referencia   : null,
  ].filter(Boolean);

  const fotosHtml = m.fotos.length
    ? `<div class="foto-row">${m.fotos.map(f =>
        `<div class="foto-thumb" title="${f.fho_nombre||''}" onclick="window.open('/uploads/fotos-recepcion/${f.fho_archivo}','_blank')">
           <img src="/uploads/fotos-recepcion/${f.fho_archivo}" alt="${f.fho_nombre||'foto'}">
         </div>`).join('')}</div>`
    : `<div class="sin-fotos">Sin fotos de recepci√≥n</div>`;

  let cotHtml = '';
  if (m.cotizacion) {
    const cot = m.cotizacion;
    const itemsHtml = cot.items.length
      ? `<div class="cot-items">${cot.items.map(it =>
          `<div class="cot-item">${it.cantidad}x ${it.nombre} ‚Äî ${money(it.precio)} c/u</div>`
        ).join('')}</div>`
      : '';
    cotHtml = `
      <div class="cot-section">
        <div class="cot-title">üí∞ Cotizaci√≥n</div>
        <div class="cot-row"><span class="lbl">Mano de obra</span><span class="val">${money(cot.mano_obra)}</span></div>
        ${cot.descripcion_trabajo ? `<div class="cot-row" style="flex-direction:column;gap:2px;"><span class="lbl">Trabajo realizado</span><span style="font-size:12px;color:#444;margin-top:2px;">${cot.descripcion_trabajo}</span></div>` : ''}
        ${itemsHtml}
        <div class="cot-subtotal"><span>Subtotal m√°quina</span><span>${money(cot.subtotal)}</span></div>
      </div>`;
  }

  return `
    <div class="maq-card">
      <div class="maq-top">
        <div>
          <div class="maq-nombre">${m.her_nombre || '-'}</div>
          ${subParts.length ? `<div class="maq-sub">${subParts.join(' | ')}</div>` : ''}
        </div>
        <span class="${badgeClass}">${estadoLabel}</span>
      </div>
      ${m.hor_observaciones ? `
        <div class="maq-obs">
          <div class="maq-obs-lbl">Observaciones de recepci√≥n</div>
          ${m.hor_observaciones}
        </div>` : ''}
      ${fotosHtml}
      ${cotHtml}
    </div>`;
}

function renderTotalCotizacion(cotOrden) {
  return `
    <div class="total-card">
      <div class="tc-item">
        <div class="tc-lbl">Subtotal</div>
        <div class="tc-val">${money(cotOrden.subtotal)}</div>
      </div>
      ${Number(cotOrden.iva) > 0 ? `
      <div class="tc-item">
        <div class="tc-lbl">IVA</div>
        <div class="tc-val">${money(cotOrden.iva)}</div>
      </div>` : ''}
      <div class="tc-item">
        <div class="tc-lbl">Total</div>
        <div class="tc-val big">${money(cotOrden.total)}</div>
      </div>
    </div>`;
}
</script>
</body>
</html>
